/*
Copyright (c) 2003-2010, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/

(function(){CKEDITOR.dialog.add('link',function(a){var b=function(){var t=this.getDialog(),u=t.getContentElement('target','popupFeatures'),v=t.getContentElement('target','linkTargetName'),w=this.getValue();if(!u||!v)return;u=u.getElement();if(w=='popup'){u.show();v.setLabel(a.lang.link.targetPopupName);}else{u.hide();v.setLabel(a.lang.link.targetFrameName);this.getDialog().setValueOf('target','linkTargetName',w.charAt(0)=='_'?w:'');}},c=function(){$('#linkUrl').html('');var t=this.getDialog(),u=['urlOptions','anchorOptions','emailOptions'],v=this.getValue(),w=t.definition.getContents('upload'),x=w&&w.hidden;if(v=='url'){if(a.config.linkShowTargetTab)t.showPage('target');if(!x)t.showPage('upload');}else{t.hidePage('target');if(!x)t.hidePage('upload');}for(var y=0;y<u.length;y++){var z=t.getContentElement('info',u[y]);if(!z)continue;z=z.getElement().getParent().getParent();if(u[y]==v+'Options')z.show();else z.hide();}},d=function(){var t=$('#linkUrl').html();$('#linkUrl').html(t.replace(/^\w+:\/\//,this.getValue()));},e=/^mailto:([^?]+)(?:\?(.+))?$/,f=/subject=([^;?:@&=$,\/]*)/,g=/body=([^;?:@&=$,\/]*)/,h=/^#(.*)$/,i=/^((?:http|https|ftp|news):\/\/)?(.*)$/,j=/^(_(?:self|top|parent|blank))$/,k=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/,l=/(?:^|,)([^=]+)=(\d+|yes|no)/gi,m=function(t,u){var v=u?u.getAttribute('_cke_saved_href')||u.getAttribute('href'):'',w='',x='',y=false,z={};if(v){w=v.match(e);x=v.match(h);y=v.match(i);}if(w){var A=v.match(f),B=v.match(g);z.type='email';z.email={};z.email.address=w[1];A&&(z.email.subject=decodeURIComponent(A[1]));B&&(z.email.body=decodeURIComponent(B[1]));}else if(x){z.type='anchor';z.anchor={};z.anchor.name=z.anchor.id=x[1];}else if(v&&y){z.type='url';z.url={};z.url.protocol=y[1];z.url.url=y[2];}else z.type='url';if(u){var C=u.getAttribute('target');z.target={};z.adv={};if(!C){var D=u.getAttribute('_cke_pa_onclick')||u.getAttribute('onclick'),E=D&&D.match(k);if(E){z.target.type='popup';z.target.name=E[1];var F;while(F=l.exec(E[2])){if(F[2]=='yes'||F[2]=='1')z.target[F[1]]=true;else if(isFinite(F[2]))z.target[F[1]]=F[2];}}}else{var G=C.match(j);if(G)z.target.type=z.target.name=C;else{z.target.type='frame';z.target.name=C;}}var H=this,I=function(O,P){var Q=u.getAttribute(P);if(Q!==null)z.adv[O]=Q||'';};I('advId','id');I('advLangDir','dir');I('advAccessKey','accessKey');I('advName','name');I('advLangCode','lang');I('advTabIndex','tabindex');I('advTitle','title');I('advContentType','type');
I('advCSSClasses','class');I('advCharset','charset');I('advStyles','style');}var J=t.document.getElementsByTag('img'),K=new CKEDITOR.dom.nodeList(t.document.$.anchors),L=z.anchors=[];for(var M=0;M<J.count();M++){var N=J.getItem(M);if(N.getAttribute('_cke_realelement')&&N.getAttribute('_cke_real_element_type')=='anchor')L.push(t.restoreRealElement(N));}for(M=0;M<K.count();M++)L.push(K.getItem(M));for(M=0;M<L.length;M++){N=L[M];L[M]={name:N.getAttribute('name'),id:N.getAttribute('id')};}this._.selectedElement=u;return z;},n=function(t,u){if(u[t])this.setValue(u[t][this.id]||'');},o=function(t){return n.call(this,'target',t);},p=function(t){return n.call(this,'adv',t);},q=function(t,u){if(!u[t])u[t]={};u[t][this.id]=this.getValue()||'';},r=function(t){return q.call(this,'target',t);},s=function(t){return q.call(this,'adv',t);};return{title:a.lang.link.title,minWidth:350,minHeight:230,contents:[{id:'searchSite',label:'Search Site',title:'Search Site',elements:[{type:'html',html:'<p>Please begin typing a page or item which you wish to link to,<br /> and select the item you would like.</p>'},{id:'searchTerm',type:'text',label:'Search'},{id:'linkUrl',type:'html',html:"<div id='linkUrlContainer'>Link: <span id='linkUrl'></span></div>"},{type:'html',html:"<div id='searchResults'></div>"}]},{id:'info',label:a.lang.link.info,title:a.lang.link.info,elements:[{id:'linkType',type:'select',label:a.lang.link.type,'default':'url',items:[[a.lang.common.url,'url'],[a.lang.link.toAnchor,'anchor'],[a.lang.link.toEmail,'email']],onChange:c,setup:function(t){if(t.type)this.setValue(t.type);},commit:function(t){t.type=this.getValue();}},{type:'vbox',id:'urlOptions',children:[{type:'hbox',widths:['25%','75%'],children:[{id:'protocol',onChange:d,type:'select',label:a.lang.common.protocol,'default':'http://',style:'width : 100%;',items:[['http://'],['https://'],['ftp://'],['news://'],['<other>','']],setup:function(t){if(t.url)this.setValue(t.url.protocol);},commit:function(t){if(!t.url)t.url={};t.url.protocol=this.getValue();}},{type:'text',id:'url',label:a.lang.common.url,onLoad:function(){this.allowOnChange=true;},onKeyUp:function(){var y=this;y.allowOnChange=false;var t=y.getDialog().getContentElement('info','protocol'),u=y.getValue(),v=/^(http|https|ftp|news):\/\/(?=.)/gi,w=/^((javascript:)|[#\/\.])/gi,x=v.exec(u);if(x){y.setValue(u.substr(x[0].length));t.setValue(x[0].toLowerCase());}else if(w.test(u))t.setValue('');y.allowOnChange=true;},onChange:function(){$('#linkUrl').html('');
if(this.allowOnChange)this.onKeyUp();},validate:function(){var t=this.getDialog();if(t.getContentElement('info','linkType')&&t.getValueOf('info','linkType')!='url')return true;if(this.getDialog().fakeObj)return true;var u=CKEDITOR.dialog.validate.notEmpty(a.lang.link.noUrl);return u.apply(this);},setup:function(t){var v=this;v.allowOnChange=false;if(t.url)v.setValue(t.url.url);v.allowOnChange=true;var u=v.getDialog().getContentElement('info','linkType');},commit:function(t){if(!t.url)t.url={};t.url.url=this.getValue();this.allowOnChange=false;}}],setup:function(t){if(!this.getDialog().getContentElement('info','linkType'))this.getElement().show();}},{type:'button',id:'browse',hidden:'true',filebrowser:'info:url',label:a.lang.common.browseServer}]},{type:'vbox',id:'anchorOptions',width:260,align:'center',padding:0,children:[{type:'html',id:'selectAnchorText',html:CKEDITOR.tools.htmlEncode(a.lang.link.selectAnchor),setup:function(t){if(t.anchors.length>0)this.getElement().show();else this.getElement().hide();}},{type:'html',id:'noAnchors',style:'text-align: center;',html:'<div>'+CKEDITOR.tools.htmlEncode(a.lang.link.noAnchors)+'</div>',setup:function(t){if(t.anchors.length<1)this.getElement().show();else this.getElement().hide();}},{type:'hbox',id:'selectAnchor',children:[{type:'select',id:'anchorName','default':'',label:a.lang.link.anchorName,style:'width: 100%;',items:[['']],setup:function(t){var w=this;w.clear();w.add('');for(var u=0;u<t.anchors.length;u++){if(t.anchors[u].name)w.add(t.anchors[u].name);}if(t.anchor)w.setValue(t.anchor.name);var v=w.getDialog().getContentElement('info','linkType');if(v&&v.getValue()=='email')w.focus();},commit:function(t){if(!t.anchor)t.anchor={};t.anchor.name=this.getValue();}},{type:'select',id:'anchorId','default':'',label:a.lang.link.anchorId,style:'width: 100%;',items:[['']],setup:function(t){var v=this;v.clear();v.add('');for(var u=0;u<t.anchors.length;u++){if(t.anchors[u].id)v.add(t.anchors[u].id);}if(t.anchor)v.setValue(t.anchor.id);},commit:function(t){if(!t.anchor)t.anchor={};t.anchor.id=this.getValue();}}],setup:function(t){if(t.anchors.length>0)this.getElement().show();else this.getElement().hide();}}],setup:function(t){if(!this.getDialog().getContentElement('info','linkType'))this.getElement().hide();}},{type:'vbox',id:'emailOptions',padding:1,children:[{type:'text',id:'emailAddress',label:a.lang.link.emailAddress,validate:function(){var t=this.getDialog();if(!t.getContentElement('info','linkType')||t.getValueOf('info','linkType')!='email')return true;
var u=CKEDITOR.dialog.validate.notEmpty(a.lang.link.noEmail);return u.apply(this);},setup:function(t){if(t.email)this.setValue(t.email.address);var u=this.getDialog().getContentElement('info','linkType');if(u&&u.getValue()=='email')this.select();},commit:function(t){if(!t.email)t.email={};t.email.address=this.getValue();}},{type:'text',id:'emailSubject',label:a.lang.link.emailSubject,setup:function(t){if(t.email)this.setValue(t.email.subject);},commit:function(t){if(!t.email)t.email={};t.email.subject=this.getValue();}},{type:'textarea',id:'emailBody',label:a.lang.link.emailBody,rows:3,'default':'',setup:function(t){if(t.email)this.setValue(t.email.body);},commit:function(t){if(!t.email)t.email={};t.email.body=this.getValue();}}],setup:function(t){if(!this.getDialog().getContentElement('info','linkType'))this.getElement().hide();}}]},{id:'target',label:a.lang.link.target,title:a.lang.link.target,elements:[{type:'hbox',widths:['50%','50%'],children:[{type:'select',id:'linkTargetType',label:a.lang.link.target,'default':'notSet',style:'width : 100%;',items:[[a.lang.common.targetNew,'_blank'],[a.lang.common.targetSelf,'_self']],onChange:b,setup:function(t){if(t.target)this.setValue(t.target.type);},commit:function(t){if(!t.target)t.target={};t.target.type=this.getValue();}},{type:'text',id:'linkTargetName',label:a.lang.link.targetFrameName,'default':'',setup:function(t){if(t.target)this.setValue(t.target.name);},commit:function(t){if(!t.target)t.target={};t.target.name=this.getValue();}}]},{type:'vbox',width:260,align:'center',padding:2,id:'popupFeatures',children:[{type:'html',html:CKEDITOR.tools.htmlEncode(a.lang.link.popupFeatures)},{type:'hbox',children:[{type:'checkbox',id:'resizable',label:a.lang.link.popupResizable,setup:o,commit:r},{type:'checkbox',id:'status',label:a.lang.link.popupStatusBar,setup:o,commit:r}]},{type:'hbox',children:[{type:'checkbox',id:'location',label:a.lang.link.popupLocationBar,setup:o,commit:r},{type:'checkbox',id:'toolbar',label:a.lang.link.popupToolbar,setup:o,commit:r}]},{type:'hbox',children:[{type:'checkbox',id:'menubar',label:a.lang.link.popupMenuBar,setup:o,commit:r},{type:'checkbox',id:'fullscreen',label:a.lang.link.popupFullScreen,setup:o,commit:r}]},{type:'hbox',children:[{type:'checkbox',id:'scrollbars',label:a.lang.link.popupScrollBars,setup:o,commit:r},{type:'checkbox',id:'dependent',label:a.lang.link.popupDependent,setup:o,commit:r}]},{type:'hbox',children:[{type:'text',widths:['30%','70%'],labelLayout:'horizontal',label:a.lang.link.popupWidth,id:'width',setup:o,commit:r},{type:'text',labelLayout:'horizontal',widths:['55%','45%'],label:a.lang.link.popupLeft,id:'left',setup:o,commit:r}]},{type:'hbox',children:[{type:'text',labelLayout:'horizontal',widths:['30%','70%'],label:a.lang.link.popupHeight,id:'height',setup:o,commit:r},{type:'text',labelLayout:'horizontal',label:a.lang.link.popupTop,widths:['55%','45%'],id:'top',setup:o,commit:r}]}]}]},{id:'advanced',label:a.lang.link.advanced,title:a.lang.link.advanced,elements:[{type:'vbox',padding:1,children:[{type:'hbox',widths:['45%','35%','20%'],children:[{type:'text',id:'advId',label:a.lang.link.id,setup:p,commit:s},{type:'select',id:'advLangDir',label:a.lang.link.langDir,'default':'',style:'width:110px',items:[[a.lang.link.langDirNotSet,''],[a.lang.link.langDirLTR,'ltr'],[a.lang.link.langDirRTL,'rtl']],setup:p,commit:s},{type:'text',id:'advAccessKey',width:'80px',label:a.lang.link.acccessKey,maxLength:1,setup:p,commit:s}]},{type:'hbox',widths:['45%','35%','20%'],children:[{type:'text',label:a.lang.link.name,id:'advName',setup:p,commit:s},{type:'text',label:a.lang.link.langCode,id:'advLangCode',width:'110px','default':'',setup:p,commit:s},{type:'text',label:a.lang.link.tabIndex,id:'advTabIndex',width:'80px',maxLength:5,setup:p,commit:s}]}]},{type:'vbox',padding:1,children:[{type:'hbox',widths:['45%','55%'],children:[{type:'text',label:a.lang.link.advisoryTitle,'default':'',id:'advTitle',setup:p,commit:s},{type:'text',label:a.lang.link.advisoryContentType,'default':'',id:'advContentType',setup:p,commit:s}]},{type:'hbox',widths:['45%','55%'],children:[{type:'text',label:a.lang.link.cssClasses,'default':'',id:'advCSSClasses',setup:p,commit:s},{type:'text',label:a.lang.link.charset,'default':'',id:'advCharset',setup:p,commit:s}]},{type:'hbox',children:[{type:'text',label:a.lang.link.styles,'default':'',id:'advStyles',setup:p,commit:s}]}]}]}],onShow:function(){var z=this;
z.fakeObj=false;var t=z.getParentEditor(),u=t.getSelection(),v=u.getRanges(),w=null,x=z;if(v.length==1){var y=v[0].getCommonAncestor(true);w=y.getAscendant('a',true);if(w&&w.getAttribute('href'))u.selectElement(w);else if((w=y.getAscendant('img',true))&&w.getAttribute('_cke_real_element_type')&&w.getAttribute('_cke_real_element_type')=='anchor'){z.fakeObj=w;w=t.restoreRealElement(z.fakeObj);u.selectElement(z.fakeObj);}else w=null;}z.setupContent(m.apply(z,[t,w]));},onOk:function(){var t={href:'javascript:void(0)/*'+CKEDITOR.tools.getNextNumber()+'*/'},u=[],v={href:t.href},w=this,x=this.getParentEditor();this.commitContent(v);switch(v.type||'url'){case 'url':var y=v.url&&v.url.protocol!=undefined?v.url.protocol:'http://',z=v.url&&v.url.url||'';t._cke_saved_href=z.indexOf('/')===0?z:y+z;break;case 'anchor':var A=v.anchor&&v.anchor.name,B=v.anchor&&v.anchor.id;t._cke_saved_href='#'+(A||B||'');break;case 'email':var C=v.email&&v.email.address,D=v.email&&encodeURIComponent(v.email.subject||''),E=v.email&&encodeURIComponent(v.email.body||''),F=['mailto:',C];if(D||E){var G=[];F.push('?');D&&G.push('subject='+D);E&&G.push('body='+E);F.push(G.join('&'));}t._cke_saved_href=F.join('');break;default:}if(v.target)if(v.target.type=='popup'){var H=["window.open(this.href, '",v.target.name||'',"', '"],I=['resizable','status','location','toolbar','menubar','fullscreen','scrollbars','dependent'],J=I.length,K=function(U){if(v.target[U])I.push(U+'='+v.target[U]);};for(var L=0;L<J;L++)I[L]=I[L]+(v.target[I[L]]?'=yes':'=no');K('width');K('left');K('height');K('top');H.push(I.join(','),"'); return false;");t[CKEDITOR.env.ie||CKEDITOR.env.webkit?'_cke_pa_onclick':'onclick']=H.join('');}else{if(v.target.type!='notSet'&&v.target.type)t.target=v.target.type;u.push('_cke_pa_onclick','onclick');}if(v.adv){var M=function(U,V){var W=v.adv[U];if(W)t[V]=W;else u.push(V);};if(this._.selectedElement)M('advId','id');M('advLangDir','dir');M('advAccessKey','accessKey');M('advName','name');M('advLangCode','lang');M('advTabIndex','tabindex');M('advTitle','title');M('advContentType','type');M('advCSSClasses','class');M('advCharset','charset');M('advStyles','style');}if(!this._.selectedElement){var N=x.getSelection(),O=N.getRanges();if(O.length==1&&O[0].collapsed){var P=new CKEDITOR.dom.text(t._cke_saved_href,x.document);O[0].insertNode(P);O[0].selectNodeContents(P);N.selectRanges(O);}var Q=new CKEDITOR.style({element:'a',attributes:t});Q.type=2;Q.apply(x.document);if(v.adv&&v.adv.advId){var R=this.getParentEditor().document.$.getElementsByTagName('a');
for(L=0;L<R.length;L++){if(R[L].href==t.href){R[L].id=v.adv.advId;break;}}}}else{var S=this._.selectedElement;if(CKEDITOR.env.ie&&t.name!=S.getAttribute('name')){var T=new CKEDITOR.dom.element('<a name="'+CKEDITOR.tools.htmlEncode(t.name)+'">',x.document);N=x.getSelection();S.moveChildren(T);S.copyAttributes(T,{name:1});T.replace(S);S=T;N.selectElement(S);}S.setAttributes(t);S.removeAttributes(u);if(S.getAttribute('name'))S.addClass('cke_anchor');else S.removeClass('cke_anchor');if(this.fakeObj)x.createFakeElement(S,'cke_anchor','anchor').replace(this.fakeObj);delete this._.selectedElement;}},onLoad:function(){var t=this.definition.dialog,u=t.getContentElement('info','linkType'),v=t.getContentElement('info','protocol'),w=t.getContentElement('info','url');$('#'+this.getContentElement('searchSite','searchTerm').domId+' input').autocomplete('/search/jquery_autocomplete.json',{dataType:'json',parse:function(x){var y=[];for(var z=0;z<x.length;z++)y[y.length]={data:x[z],value:x[z]};return y;},formatItem:function(x){return x.name;}}).result(function(x,y,z){u.setValue('url');v.setValue('http://');w.setValue(y.url.replace(/^http:\/\//,''));$('#linkUrl').html(y.url);});if(!a.config.linkShowAdvancedTab)this.hidePage('advanced');if(!a.config.linkShowTargetTab)this.hidePage('target');}};});})();
